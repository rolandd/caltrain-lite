# Deployment Guide: generic.example.com

This guide details how to deploy the Transit PWA and Worker stack to Cloudflare, specifically targeting the domain `transit.example.com`.

## Architecture Recap

1.  **Backend (Worker)**: Handles `/api/*` (Realtime GTFS, Schedule Meta).
    - Deployed via: `wrangler` (CLI).
    - Infrastructure: Cloudflare Worker + KV.
2.  **Frontend (PWA)**: SvelteKit Static Adapter found at `apps/pwa`.
    - Deployed via: Cloudflare Pages (Git Integration).
    - Infrastructure: Cloudflare Pages.
3.  **Data Sync**: GitHub Action (Daily Cron).
    - Deployed via: GitHub (`.github/workflows/sync-schedule.yml`).

## Prerequisites

1.  **Cloudflare Account**: You need an active Cloudflare account.
2.  **Tools**:
    - `node` (v20+) & `npm`
    - `terraform`
    - `wrangler` (installed via `npm install -g wrangler` or run with `npx`)
3.  **Authentication**:
    - Run `npx wrangler login` to authenticate your local machine.

---

## Step 1: API Token Setup

You need to obtain a 511.org API token.

1. Go to **[511.org token request form](https://511.org/open-data/token)**
   and complete the process.

You also need to create a Cloudflare API Token with specific
permissions to allow Terraform to manage your infrastructure.

1.  Go to **[Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens)** > **My Profile** > **API Tokens**.
2.  Click **Create Token**.
3.  Use the **Edit Cloudflare Workers** template as a base, but ensure the following permissions are set:
    - **Account Resources** (Include: `All accounts` or your specific account):
      - `Workers Scripts`: **Edit**
      - `Workers KV Storage`: **Edit**
      - `Pages`: **Edit**
    - **Zone Resources** (Include: `Specific zone` > `your-domain.com`):
      - `Workers Routes`: **Edit**
      - `DNS`: **Edit**
      - `SSL and Certificates`: **Read**

---

## Step 2: Infrastructure Setup (One-Time)

Ensure you have run the Terraform configuration to create the KV Namespace.

```bash
# 1. Copy example vars
cp infra/terraform.tfvars.example infra/terraform.tfvars

# 2. Fill in your Cloudflare credentials
vim infra/terraform.tfvars
# (Add updated variables: cloudflare_api_token, cloudflare_account_id, cloudflare_zone_id, domain, github_owner, github_repo)

# 3. Apply Terraform
cd infra
terraform init
terraform apply
```

> **Result**: This automatically:
>
> - Creates the `transit-kv` namespace.
> - Creates the `transit-pwa` Pages project (with Node 24).
> - Generates `worker/wrangler.toml` with the correct KV ID and Routes.

---

## Step 3: Deploy the Worker (Backend)

We deploy the Worker first.

1.  **Deploy**:

    ```bash
    cd worker
    npx wrangler deploy
    ```

    - **What this does**: Creates the Worker project, uploads code, binds KV, and **sets up the Route** (`transit.example.com/api/*`) in Cloudflare.
    - _Note_: This deploys the worker to your `workers.dev` subdomain initially (e.g., `transit-worker.your-name.workers.dev`).

2.  **Set Secrets** (Production):

    ```bash
    npx wrangler secret put TRANSIT_511_API_KEY
    # Enter your 511.org API Key when prompted
    ```

    - _Note_: The route is automatically configured via `wrangler.toml` (generated by Terraform).

---

## Step 4: Deploy the PWA (Frontend)

The Pages project was created by Terraform. Now we connect it to Git (one-time setup) or just push to deploy if already connected.

1.  **Go to Cloudflare Dashboard** > **Workers & Pages** > **transit-pwa**.
2.  **Connect to Git**:
    - Go to **Settings** > **Git Integration** (or "Connect to Git" if prompted).
    - Select your repo (`roland/Transit`).
    - Branch: `main`.
    - Build settings (already configured by TF, but verify):
      - Command: `npm run build --prefix apps/pwa`
      - Output: `apps/pwa/build`
      - Root: `/` (Repository root)
      - Env Vars: `NODE_VERSION: 24`

---

## Step 5: Configure Domain

1.  **Go to Cloudflare Dashboard** > **Workers & Pages** > **transit-pwa** (your Pages project) > **Custom Domains**.
2.  **Set up a Custom Domain**:
    - Domain: `transit.example.com`
    - Follow instructions to add the DNS record (Cloudflare usually handles this automatically if you manage the zone).

---

## Step 6: Verification

1.  **Visit `https://transit.example.com`**: You should see the PWA.
2.  **Visit `https://transit.example.com/api/realtime`**: You should see JSON output (handled by the Worker).
3.  **Check Data**: Ensure the PWA loads (it might be empty until the GitHub Action runs).

## Step 7: Initial Data Populate

Trigger the GitHub Action manually to populate the KV store for the first time.

1.  Go to **GitHub Repo** > **Actions** > **Sync Schedule**.
2.  Click **Run workflow**.

Once complete, your PWA will have schedule data!
